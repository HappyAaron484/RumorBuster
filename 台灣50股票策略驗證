import pandas as pd
import sqlite3
import yfinance as yf
import datetime as dt
import os

# è¨­å®šè³‡æ–™åº«æª”æ¡ˆ
db_file = "stocks_taiwan50.db"

# ç¢ºä¿ SQLite é€£æ¥å®‰å…¨
def get_db_connection():
    return sqlite3.connect(db_file)

# åˆå§‹åŒ–è³‡æ–™åº«
def initialize_database():
    with get_db_connection() as conn:
        conn.execute('''
            CREATE TABLE IF NOT EXISTS stocks (
                Date TEXT,
                Stock TEXT,
                Open REAL,
                High REAL,
                Low REAL,
                Close REAL,
                Volume INTEGER,
                PRIMARY KEY (Date, Stock)
            );
        ''')
        print("ğŸ“Œ è³‡æ–™åº«å·²å»ºç«‹æˆ–å·²å­˜åœ¨ï¼")

# å°ç£ 50 æˆåˆ†è‚¡ï¼ˆé€™è£¡åƒ…ä¿ç•™éƒ¨åˆ†è‚¡ç¥¨ï¼‰
taiwan_50_stocks = [
    "2308.TW", "2317.TW", "2327.TW", "2330.TW", "2352.TW",
]

# ä¸‹è¼‰æ­·å²æ•¸æ“š
def download_stock_data():
    with get_db_connection() as conn:
        for stock in taiwan_50_stocks:
            print(f"ğŸ“¥ ä¸‹è¼‰ {stock} çš„æ—¥ K ç·šè³‡æ–™...")
            try:
                # ä½¿ç”¨å…¨åŸŸè¨­å®šçš„å›æ¸¬åƒæ•¸æ—¥æœŸ
                stock_data = yf.download(stock, start=start_date, end=end_date, auto_adjust=False)

                if stock_data.empty:
                    print(f"âš ï¸ {stock} ç„¡æ•¸æ“šï¼Œè·³é...")
                    continue

                stock_data.reset_index(inplace=True)  # è®“ Date æˆç‚ºå–®ç¨æ¬„ä½
                stock_data["Date"] = stock_data["Date"].astype(str)
                stock_data["Stock"] = stock

                # ä¿®æ­£ MultiIndex æ¬„ä½ï¼ˆè‹¥æœ‰ï¼‰
                stock_data.columns = [col[0] if isinstance(col, tuple) else col for col in stock_data.columns]

                # åªä¿ç•™éœ€è¦çš„æ¬„ä½
                stock_data = stock_data[["Date", "Stock", "Open", "High", "Low", "Close", "Volume"]]

                # æ¸…é™¤èˆŠæ•¸æ“šï¼Œé¿å…é‡è¤‡
                conn.execute(f"DELETE FROM stocks WHERE Stock = '{stock}'")
                stock_data.to_sql("stocks", conn, if_exists="append", index=False)
                print(f"âœ… {stock} è³‡æ–™å·²æ›´æ–°ã€‚")
            except Exception as e:
                print(f"âš ï¸ ä¸‹è¼‰ {stock} å¤±æ•—: {e}")

# è¨­å®šå›æ¸¬åƒæ•¸
start_date = "2024-01-01"
end_date = "2024-12-31"
initial_capital = 10000000  # åˆå§‹è³‡é‡‘ 1000 è¬

# è®€å–è³‡æ–™åº«
def load_stock_data():
    with get_db_connection() as conn:
        sql_query = f"SELECT * FROM stocks WHERE Date BETWEEN '{start_date}' AND '{end_date}'"
        stocks_data = pd.read_sql_query(sql_query, conn)

    if stocks_data.empty:
        print("âŒ éŒ¯èª¤: stocks_data ç‚ºç©ºï¼Œè«‹ç¢ºèªæ•¸æ“šä¸‹è¼‰æ˜¯å¦æˆåŠŸã€‚")
        exit()

    stocks_data["Date"] = pd.to_datetime(stocks_data["Date"])
    return stocks_data

# è¨ˆç®—å¸ƒæ—é€šé“
def calculate_bollinger_bands(stocks_data):
    stocks_data["SMA_20"] = stocks_data.groupby("Stock")["Close"].transform(lambda x: x.rolling(20).mean())
    stocks_data["StdDev_20"] = stocks_data.groupby("Stock")["Close"].transform(lambda x: x.rolling(20).std())
    stocks_data["Upper_Band"] = stocks_data["SMA_20"] + (2 * stocks_data["StdDev_20"])
    stocks_data["Lower_Band"] = stocks_data["SMA_20"] - (2 * stocks_data["StdDev_20"])
    return stocks_data

# ç”¢ç”Ÿäº¤æ˜“è¨Šè™Ÿ
def generate_signals(stocks_data):
    stocks_data["Signal"] = ""
    stocks_data.loc[(stocks_data["Close"] > stocks_data["Upper_Band"]) & 
                    (stocks_data["Close"].shift(1) <= stocks_data["Upper_Band"].shift(1)), "Signal"] = "Sell"
    stocks_data.loc[(stocks_data["Close"] < stocks_data["Lower_Band"]) & 
                    (stocks_data["Close"].shift(1) >= stocks_data["Lower_Band"].shift(1)), "Signal"] = "Buy"
    return stocks_data

# å›æ¸¬èˆ‡è¨˜éŒ„æ¯æ—¥ã€æ¯æœˆã€æ¯åŠå¹´çš„æŠ•è³‡çµ„åˆç‹€æ³å’Œæç›Š
def backtest(stocks_data):
    portfolio = {}   # ä½¿ç”¨ dict ä¾†è¨˜éŒ„æŒæœ‰çš„æ¨™çš„èˆ‡è‚¡æ•¸ï¼Œä¾‹å¦‚ {"2330.TW": 3000}
    capital = initial_capital
    daily_records = []  # ç´€éŒ„æ¯æ—¥çµ„åˆç‹€æ…‹

    # ç¢ºä¿è³‡æ–™ä¾æ—¥æœŸæ’åº
    stocks_data = stocks_data.sort_values(by="Date")
    unique_dates = stocks_data["Date"].unique()

    for date in unique_dates:
        # ç•¶å¤©æ‰€æœ‰è³‡æ–™
        date_data = stocks_data[stocks_data["Date"] == date]
        # è™•ç†ç•¶å¤©çš„äº¤æ˜“è¨Šè™Ÿ
        signals_today = date_data[date_data["Signal"] != ""]
        for idx, row in signals_today.iterrows():
            stock = row["Stock"]
            signal = row["Signal"]
            close = row["Close"]
            if signal == "Buy":
                if capital >= close * 1000:
                    shares_to_buy = (capital // (close * 1000)) * 1000
                    transaction_cost = (close * shares_to_buy) * (0.1425 / 100)
                    cost = close * shares_to_buy + transaction_cost
                    if capital >= cost:
                        capital -= cost
                        portfolio[stock] = portfolio.get(stock, 0) + shares_to_buy
                        print(f"{date.date()} è²·é€² {stock} {shares_to_buy} è‚¡ï¼Œåƒ¹æ ¼ {close:.2f}")
            elif signal == "Sell":
                if stock in portfolio and portfolio[stock] > 0:
                    shares_to_sell = portfolio[stock]
                    tax_cost = (close * shares_to_sell) * (0.3 / 100)
                    transaction_cost = (close * shares_to_sell) * (0.1425 / 100)
                    proceeds = close * shares_to_sell - tax_cost - transaction_cost
                    capital += proceeds
                    print(f"{date.date()} è³£å‡º {stock} {shares_to_sell} è‚¡ï¼Œåƒ¹æ ¼ {close:.2f}")
                    portfolio[stock] = 0
        # æ¸…é™¤æŒå€‰ä¸­æ•¸é‡ç‚º 0 çš„è‚¡ç¥¨
        portfolio = {k: v for k, v in portfolio.items() if v > 0}

        # è¨ˆç®—ç•¶å¤©æŒæœ‰çµ„åˆçš„å¸‚å€¼
        day_portfolio_value = 0
        positions_snapshot = {}
        for stock, shares in portfolio.items():
            # å˜—è©¦å¾ç•¶å¤©æ•¸æ“šä¸­å–å¾—è©²è‚¡ç¥¨çš„æ”¶ç›¤åƒ¹ï¼Œè‹¥ç„¡å‰‡è¨­ç‚º 0
            stock_data_today = date_data[date_data["Stock"] == stock]
            if not stock_data_today.empty:
                price = stock_data_today["Close"].iloc[0]
            else:
                price = 0
            value = shares * price
            positions_snapshot[stock] = {"shares": shares, "price": price, "value": value}
            day_portfolio_value += value

        total_value = capital + day_portfolio_value
        daily_records.append({
            "Date": date,
            "Capital": capital,
            "Portfolio_Value": day_portfolio_value,
            "Total_Value": total_value,
            "Positions": positions_snapshot
        })

    # è½‰æ›æ¯æ—¥è¨˜éŒ„ç‚º DataFrame
    daily_df = pd.DataFrame(daily_records)
    daily_df["Date"] = pd.to_datetime(daily_df["Date"])
    daily_df = daily_df.sort_values("Date")

    # -----------------------
    # è¨ˆç®—æ¯å€‹æœˆçš„æŒè‚¡ç‹€æ³èˆ‡æç›Š
    # -----------------------
    daily_df["YearMonth"] = daily_df["Date"].dt.to_period("M")
    # ä»¥æ¯æœˆæœ€å¾Œä¸€å¤©çš„ç‹€æ…‹ä½œç‚ºè©²æœˆçš„ç‹€æ…‹
    monthly_df = daily_df.groupby("YearMonth").last().reset_index()
    monthly_df["Monthly_PnL"] = monthly_df["Total_Value"].diff()

    # -----------------------
    # è¨ˆç®—æ¯åŠå¹´çš„æŒè‚¡ç‹€æ³èˆ‡æç›Š
    # -----------------------
    # è‡ªå®šåŠå¹´åº¦ï¼š1~6 æœˆç‚ºä¸ŠåŠå¹´ï¼Œ7~12 æœˆç‚ºä¸‹åŠå¹´
    daily_df["Half"] = daily_df["Date"].dt.month.apply(lambda m: 1 if m <= 6 else 2)
    daily_df["Year"] = daily_df["Date"].dt.year
    daily_df["YearHalf"] = daily_df["Year"].astype(str) + "-H" + daily_df["Half"].astype(str)
    semiannual_df = daily_df.groupby("YearHalf").last().reset_index()
    semiannual_df["Semiannual_PnL"] = semiannual_df["Total_Value"].diff()

    return daily_df, monthly_df, semiannual_df, portfolio, capital

# ä¸»ç¨‹åºæµç¨‹
if __name__ == "__main__":
    initialize_database()

    if input("æ˜¯å¦ä¸‹è¼‰æœ€æ–°æ•¸æ“š (Y/N)? ").lower() == "y":
        download_stock_data()

    stocks_data = load_stock_data()
    stocks_data = calculate_bollinger_bands(stocks_data)
    stocks_data = generate_signals(stocks_data)

    daily_df, monthly_df, semiannual_df, final_portfolio, final_capital = backtest(stocks_data)

    print("\nğŸ“ˆ **å›æ¸¬çµæœ**")
    print(f"ğŸ’° æœ€çµ‚å‰©é¤˜è³‡é‡‘: {final_capital:.2f}")
    print(f"ğŸ“Š æœ€çµ‚æŒæœ‰è‚¡ç¥¨: {final_portfolio}")

    print("\nğŸ—“ æ¯æœˆæŒè‚¡æƒ…æ³èˆ‡æç›Šï¼š")
    # é€™è£¡é¡¯ç¤ºæ¯æœˆæ—¥æœŸã€ç¸½è³‡ç”¢åƒ¹å€¼åŠè©²æœˆæç›Šï¼ˆè‹¥æœ‰ï¼‰
    print(monthly_df[["YearMonth", "Total_Value", "Monthly_PnL"]])

    print("\nğŸ—“ æ¯åŠå¹´åº¦æŒè‚¡æƒ…æ³èˆ‡æç›Šï¼š")
    print(semiannual_df[["YearHalf", "Total_Value", "Semiannual_PnL"]])
